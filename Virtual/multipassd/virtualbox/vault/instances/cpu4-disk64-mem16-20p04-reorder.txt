# -*- sh-shell: bash -*-
#cloud-config
apt:
  primary:
    - arches:
        - default
      uri: "http://archive.ubuntu.com/ubuntu"
debconf-selections: "base-config apt-setup/restricted boolean true\nbase-config apt-setup/universe boolean true\nbase-config apt-setup/backports boolean true\nbase-config apt-setup/main boolean true\nbase-config apt-setup/multiverse boolean true\n"
identity:
  hostname: string      xubark
  realname: string      econ-ark
  username: string      econ-ark
locale: en_US.UTF-8
version: 1
packages:
  - git
  - emacs
runcmd:
  - echo '# Set up debugging:'
  - sudo set -x
  - sudo set -v
  - echo ''
  - cd /usr/local/share/data/GitHub/econ-ark/econ-ark-tools
  - echo ' '
  - echo '# late_command:'
  - echo '0. update; git; clone econ-ark-tools; copy to /var/local; install rc.local; mark Size-To-Make; disk labels'
  - echo ''
  - sudo echo '/usr/local/share/data/GitHub/econ-ark/econ-ark-tools/Virtual/Machine/ISO-maker/Files/For-Target/late_command.sh 2>&1 | tee /tmp/late_command.log'
  - echo '# Rename machine'
  - echo ''
  - sudo echo /var/local/rename-hostname.sh
  - echo ' '
  - echo '# Add econ-ark, econ-ark-xrdb users'
  - echo ' '
  - sudo echo /var/local/add-users.sh
  - sudo echo 'DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true DEBCONF_DEBUG=.* apt -y install lightdm'
  - sudo echo chmod a+w /etc/X11/default-display-manager
  - sudo echo "/usr/sbin/lightdm" > /etc/X11/default-display-manager
  - sudo sudo echo 'DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true DEBCONF_DEBUG=.* dpkg-reconfigure lightdm'
  - sudo echo set shared/default-x-display-manager lightdm | DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true DEBCONF_DEBUG=.* sudo debconf-communicate 
  - echo "/usr/local/share/data/GitHub/econ-ark/econ-ark-tools/Virtual/Machine/ISO-maker/Files/For-Target/late_command.sh 2>&1 | tee /tmp/late_command.log"
  - echo "cp /tmp/late_command.log /var/local"
  - echo echo "'late_command finished' >> /tmp/late_command.log"
  - echo "DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true DEBCONF_DEBUG=.* apt -y install xfce4"
  - echo "DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true DEBCONF_DEBUG=.* apt -y install xubuntu-desktop"
  - echo "apt -y install xfce4-goodies xorg dbus-x11 x11-xserver-utils xrdp"
  - echo "useradd --create-home --password $(perl -e 'print crypt($ARGV[0],"econ-ark")' "kra-noce") --shell /bin/bash --groups adm,echo,admin,dialout,cdrom,floppy,audio,dip,video,plugdev,netdev,lxd econ-ark econ-ark"
  - echo "useradd --create-home --password $(perl -e 'print crypt($ARGV[0],"econ-ark")' "kra-noce") --shell /bin/bash --groups adm,echo,admin,dialout,cdrom,floppy,audio,dip,video,plugdev,netdev,lxd econ-ark econ-ark-xrdp"
  - echo "usermod -aG nopasswdlogin econ-ark"
  - echo "usermod -aG nopasswdlogin ubuntu"
  - echo "mkdir -p   /usr/share/lightdm/lightdm.conf.d"
  - echo "mkdir -p   /etc/systemd/system/getty@tty1.service.d"
  - echo "cp /var/local/root/etc/systemd/system/getty@tty1.service.d/override.conf /etc/systemd/system/getty@tty1.service.d/override.conf"
  - echo "chmod 755 /etc/systemd/system/getty@tty1.service.d/override.conf"
  - echo "cp /var/local/root/etc/lightdm/lightdm-gtk-greeter.conf /etc/lightdm/lightdm-gtk-greeter.conf"
  - echo "/var/local/setup-tigervnc-scraping-server.sh  # install and set password"
  - echo "service xrdp stop # automatically starts and occupies :0"
  - echo "-u econ-ark-xrdp /bin/bash -c (DBUS_SESSION_BUS_ADDRESS=$(dbus-launch --sh-syntax) ; export DBUS_SESSION_BUS_ADDRESS=$DBUS_SESSION_BUS_ADDRESS)" # Start dbus and make its info an environment variable"
  - echo "echo xfce4-session > /home/econ-ark-xfce/.xsession"
  - echo "chmod a+x /home/econ-ark-xfce/.xsession"
  - echo "chown a+x econ-ark-xfce /home/econ-ark-xfce/.xsession"
  - echo "chmod u+w /etc/xrdp/xrdp.ini"
  - echo "echo '\n[xrdp0]\nname=xubuntark\lib=libvnc.so\username=econ-ark-xrdp\npassword=ask\ip=127.0.0.1\port=5912\n' >> /etc/xrdp/xrdp.ini"
  - echo "service xrdp start"
  - echo "service lightdm start"
  - echo "startxfce4 "
  - sleep 20 # Give xfce4 time to start up before starting vnc server "
  - echo "x0vncserver -display :0 -PasswordFile=/root/.vnc/passwd &"
  - echo "/etc/rc.local"
  
